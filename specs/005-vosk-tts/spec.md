# Feature Specification: Vosk TTS Integration

**Feature Branch**: `005-vosk-tts`  
**Created**: 2025-12-12  
**Status**: Draft  
**Input**: User description: "Добавляем новый модуль tts - vosk tts. Выполняем стандартную реализацию: модуль синтеза с интерфейсом, аналогичным уже существующим методам; cli утилита; добавляем в бота - настройки в .env"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Синтез речи через Vosk TTS (Priority: P1)

Администратор выбирает Vosk TTS как движок синтеза, и бот озвучивает входящие посты голосами Vosk без дополнительных действий пользователей.

**Why this priority**: Основная ценность — новый TTS движок доступен сразу после включения.

**Independent Test**: Указать `TTS_ENGINE=vosk` в конфиге, отправить текстовый пост боту, получить аудио, убедиться что озвучка выполнена Vosk.

**Acceptance Scenarios**:

1. **Given** бот настроен на Vosk TTS с валидной моделью, **When** пользователь отправляет текстовый пост, **Then** бот отвечает аудиосообщением, сгенерированным Vosk.
2. **Given** Vosk TTS активен, **When** синтез завершается успешно, **Then** аудио соответствует качеству модели без артефактов.

---

### User Story 2 - CLI утилита для Vosk TTS (Priority: P2)

Разработчик или администратор может синтезировать речь через командную строку без запуска бота для тестирования и отладки.

**Why this priority**: Удобство разработки и проверки конфигурации без полного развёртывания бота.

**Independent Test**: Вызвать CLI команду `vosk-tts --text "Привет" --out test.wav`, получить аудиофайл.

**Acceptance Scenarios**:

1. **Given** установлена модель Vosk, **When** пользователь запускает CLI с текстом, **Then** создаётся аудиофайл в указанном формате.
2. **Given** CLI вызвана с параметрами модели и speaker_id, **When** синтез выполняется, **Then** используется указанный голос.

---

### User Story 3 - Выбор голоса/speaker_id (Priority: P3)

Администратор может выбрать конкретный голос (speaker_id) из мультиголосовой модели Vosk через конфигурацию.

**Why this priority**: Vosk поддерживает модели с несколькими голосами (0-4 для русской модели), важна возможность выбора.

**Independent Test**: Изменить `TTS_SPEAKER_ID` в конфиге, синтезировать текст, убедиться что голос изменился.

**Acceptance Scenarios**:

1. **Given** указан speaker_id в пределах доступных голосов модели, **When** синтез выполняется, **Then** используется выбранный голос.
2. **Given** указан невалидный speaker_id, **When** загрузка конфигурации происходит, **Then** система выдаёт понятную ошибку.

---

### Edge Cases

- Некорректное имя модели Vosk в конфигурации.
- speaker_id вне допустимого диапазона для модели.
- Модель не скачана и нет доступа к сети.
- Текст превышает допустимую длину.
- Пустой текст для синтеза.
- Недоступность дискового пространства для кеша модели.

### Assumptions

- Vosk TTS устанавливается через pip (`pip install vosk-tts`).
- Модели скачиваются автоматически библиотекой vosk-tts по имени (например `vosk-model-tts-ru-0.9-multi`).
- Интерфейс модуля синтеза соответствует `SynthesisProvider` протоколу проекта.
- CLI утилита следует паттерну существующих CLI (`silero_tts.py`, `piper_tts.py`).
- Конфигурация через существующие переменные окружения с добавлением vosk-специфичных при необходимости.
- Формат аудио выхода (wav/mp3) настраивается через общие TTS переменные окружения.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST поддерживать Vosk TTS как движок синтеза речи через значение `TTS_ENGINE=vosk`.
- **FR-002**: Модуль синтеза Vosk MUST реализовывать протокол `SynthesisProvider` с методом `synth(text, prefix, out_path)`.
- **FR-003**: Система MUST поддерживать выбор модели Vosk через переменную `TTS_MODEL` (например `vosk-model-tts-ru-0.9-multi`).
- **FR-004**: Система MUST поддерживать выбор голоса через `TTS_SPEAKER_ID` для мультиголосовых моделей.
- **FR-005**: CLI утилита MUST принимать параметры `--text/--text-file`, `--out`, опционально `--model`, `--speaker-id`, `--format`.
- **FR-006**: Система MUST автоматически скачивать модель при первом использовании если она отсутствует локально.
- **FR-007**: Система MUST логировать метрики синтеза (время загрузки модели, время синтеза, длительность аудио).
- **FR-008**: Система MUST валидировать speaker_id при загрузке и возвращать понятную ошибку при невалидном значении.

### Key Entities

- **VoskConfig**: конфигурация модуля (model_name, speaker_id, cache_dir, audio_format, metrics_path).
- **VoskSynthesis**: класс синтеза, реализующий SynthesisProvider.
- **TTSEngine.VOSK**: новое значение enum для выбора движка.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Синтез текста до 1000 символов завершается успешно в 95% случаев.
- **SC-002**: Время синтеза типичного сообщения (до 500 символов) не превышает 5 секунд.
- **SC-003**: CLI команда возвращает код 0 при успешном синтезе и ненулевой код при ошибке.
- **SC-004**: Переключение на Vosk через конфигурацию не требует изменений кода.

