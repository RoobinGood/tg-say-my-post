# Feature Specification: MeloTTS support and model switching

**Feature Branch**: `003-melotts-tts`  
**Created**: 2025-12-10  
**Status**: Rejected (нет русской модели MeloTTS; ценность не оправдана)  
**Input**: User description: "новая фича: добавить поддержку MeloTTS в качестве движка синтеза речи. Сделай по аналогии с внедрением поддержки silero. добавить в конфиг возможность переключать модель для бота"

## Clarifications

### Session 2025-12-10

- Q: Какое поведение при недоступности выбранного движка? → A: Не переключать, вернуть пользователю понятное сообщение об ошибке, уведомить администратора.
- Q: Как применяется смена движка/модели из конфига? → A: Меняем переменные/файл конфига, перезапуск процесса для применения.
- Q: Что делать, если модель для выбранного движка не указана? → A: Блокировать загрузку конфига с явной ошибкой для администратора.
- Q: Куда отправлять уведомление администратору о проблемах с конфигом/синтезом? → A: Только логирование без уведомлений.
- Q: Максимальная длина текста для синтеза? → A: Лимит задаётся в конфиге, един для всех моделей.
- Q: Как получать веса MeloTTS? → A: При старте, если веса отсутствуют, автоматически скачать в кеш с проверкой checksum/размера; при ошибке старт блокируется с понятной ошибкой.
- Q: Где размещён MeloTTS? → A: Локально на хосте с установленными весами, без удалённого endpoint.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Синтез через MeloTTS (Priority: P1)

Администратор включает MeloTTS как движок синтеза, и бот озвучивает входящие посты этим голосом без ручного вмешательства пользователя.

**Why this priority**: Дает основную ценность — новая озвучка доступна сразу после включения.

**Independent Test**: Включить MeloTTS в конфиге, отправить пост, получить аудио, убедиться что озвучка от MeloTTS.

**Acceptance Scenarios**:

1. **Given** бот настроен на MeloTTS, **When** пользователь отправляет текстовый пост, **Then** бот отвечает аудиосообщением, сгенерированным MeloTTS.
2. **Given** MeloTTS доступен, **When** запрос синтеза выполняется, **Then** ответ приходит без деградации качества по сравнению с текущими голосами.

---

### User Story 2 - Переключение движка и модели (Priority: P2)

Администратор может переключить движок синтеза между Silero и MeloTTS и выбрать модель/голос без деплоя.

**Why this priority**: Нужна гибкость выбора голоса и возможность быстрых тестов/замены.

**Independent Test**: Изменить конфигурацию на другой движок и модель, перезапустить/перечитать конфиг, убедиться что следующий пост озвучен новым голосом.

**Acceptance Scenarios**:

1. **Given** указано имя движка и модели, **When** конфигурация применяется, **Then** бот использует выбранный голос для всех новых постов.
2. **Given** введено неподдерживаемое имя движка или модели, **When** конфигурация загружается, **Then** бот сообщает об ошибке администратору и не падает.

---

### User Story 3 - Непрерывность работы (Priority: P3)

При недоступности выбранного движка бот сохраняет работоспособность, использует запасной вариант или корректно уведомляет администратора.

**Why this priority**: Снижает простой и негативный опыт пользователей.

**Independent Test**: Смоделировать недоступность MeloTTS, проверить что бот либо переключился на доступный движок, либо дал понятное сообщение об ошибке без краша.

**Acceptance Scenarios**:

1. **Given** выбранный движок недоступен, **When** бот получает запрос на синтез, **Then** он либо использует резервный движок, либо отправляет пользователю дружелюбное уведомление и логирует проблему.
2. **Given** повторная доступность выбранного движка, **When** он снова отвечает, **Then** бот возвращается к нему без дополнительной ручной настройки.

### Edge Cases

- Некорректное имя движка или модели в конфигурации.
- Недоступность API/ресурсов MeloTTS или Silero во время синтеза.
- Текст поста превышает допустимую длину или содержит неподдерживаемые символы/языки.
- Тайм-ауты или задержки синтеза, ведущие к отмене/повтору запроса.
- Ошибка скачивания или повреждение весов MeloTTS (например, недоступный URL, несоответствие checksum, нехватка места/прав).

### Assumptions

- Переключение движка происходит через существующий конфиг/переменные окружения без изменений кода.
- У администратора есть канал уведомлений об ошибках загрузки конфигурации или синтеза.
- Формат аудио-ответа для пользователей остается тем же, что и у текущего бота.
- MeloTTS работает локально на хосте; при отсутствии весов движок пытается скачать их при старте в кеш, при ошибке старт блокируется.
- MeloTTS работает локально на хосте с установленными весами; удалённые endpoints не используются.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система MUST поддерживать выбор движка синтеза речи между Silero и MeloTTS через конфигурацию окружения.
- **FR-002**: Система MUST озвучивать пользовательские посты выбранным движком и отдавать аудиосообщение пользователю.
- **FR-003**: Система MUST позволять задавать модель/голос MeloTTS и Silero в конфигурации без правок кода; при отсутствии значения загрузка конфигурации блокируется с явной ошибкой для администратора.
- **FR-004**: Система MUST валидировать значения движка и модели при загрузке конфигурации и при ошибке логировать проблему без уведомлений, не прекращая работу бота.
- **FR-005**: Система MUST при недоступности выбранного движка не переключать его автоматически, возвращать пользователю понятное сообщение об ошибке и логировать проблему без уведомлений, не роняя бота.
- **FR-007**: Система MUST иметь единый для всех моделей лимит длины текста, задаваемый в конфигурации; при превышении лимита запрос отклоняется с понятным сообщением без вызова TTS и с логированием.
- **FR-006**: Система MUST вести диагностические записи для каждой попытки синтеза (движок, модель, длительность, ошибки) для администраторского контроля.
- **FR-008**: Система MUST автоматически скачивать отсутствующие веса MeloTTS при старте с проверкой целостности (checksum/размер), кешировать в заданной директории и блокировать старт с понятной ошибкой при неуспехе.

### Key Entities *(include if feature involves data)*

- **Настройка движка TTS**: выбранный движок (Silero, MeloTTS), способ переключения (переменные окружения/конфиг), приоритет резервного движка.
- **Профиль модели/голоса**: идентификатор модели, язык/голос, ограничения по длине текста, требуемые параметры для вызова.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Не менее 95% запросов синтеза завершаются успешно с выбранным движком за сутки типичной нагрузки.
- **SC-002**: Переключение движка или модели через конфигурацию применяется без изменения кода и начинает использоваться в первом же новом запросе после перезагрузки/перечитывания конфига.
- **SC-003**: Для типового сообщения длиной до 1 000 символов аудио-ответ формируется и доставляется пользователю в течение 5 секунд в 95% случаев.
- **SC-004**: При недоступности выбранного движка система возвращает понятное уведомление пользователю и логирует ошибку в 100% случаев без падения бота.
