# Feature Specification: Silero TTS module with metrics

**Feature Branch**: `[002-silero-tts]`  
**Created**: 2025-12-10  
**Status**: Delivered  
**Input**: User description: "Реализуй модуль синтеза речи на основе модели https://github.com/snakers4/silero-models . Обложи его метриками, чтобы понимать, сколько времени занимает генерация. Должен быть cli чтобы потыкать генерацию через консоль Настройки модуля вынеси в конфиг"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Синтез текста через CLI (Priority: P1)

Разработчик запускает CLI, передает короткий текст и получает сгенерированный аудиофайл выбранным голосом без доп. настроек.

**Why this priority**: Даёт быстрый способ убедиться, что TTS работает и возвращает звук.

**Independent Test**: Запустить CLI с текстом до 500 символов, получить путь к файлу, проверить, что файл существует и содержит звук ожидаемой длительности.

**Acceptance Scenarios**:

1. **Given** корректно установлен модуль и доступ к модели, **When** разработчик вызывает CLI с текстом, **Then** сохраняется аудиофайл и CLI сообщает путь к нему.
2. **Given** указан формат вывода по умолчанию, **When** CLI завершается, **Then** код выхода равен 0 и лог содержит длительность генерации.

---

### User Story 2 - Настройка через конфиг (Priority: P2)

Инженер меняет файл конфигурации (голос, язык, формат аудио, путь для вывода) и повторно запускает CLI без правки кода.

**Why this priority**: Позволяет быстро менять параметры синтеза и упрощает развёртывание в разных средах.

**Independent Test**: Обновить конфиг, запустить CLI и проверить, что применены новые параметры без изменения исходников.

**Acceptance Scenarios**:

1. **Given** новый голос и язык заданы в конфиге, **When** выполняется повторный запуск CLI, **Then** генерация использует обновленные параметры.

---

### User Story 3 - Наблюдение метрик (Priority: P3)

Разработчик получает метрики по времени генерации и длительности аудио для каждого запроса, чтобы оценить производительность.

**Why this priority**: Делает поведение прозрачным и позволяет измерять улучшения или деградации.

**Independent Test**: Запустить несколько вызовов CLI и убедиться, что метрики времени и длительности выводятся или записываются в указанный канал и их можно агрегировать.

**Acceptance Scenarios**:

1. **Given** включены метрики, **When** выполняются 3 последовательных синтеза, **Then** для каждого запроса зафиксированы wall-clock время и длительность аудио.

---

### User Story 4 - Подключение в боте (Priority: P2)

Инженер включает выбранный модуль синтеза из конфига в бота, чтобы бот мог отдавать голосовые ответы.

**Why this priority**: Интеграция в бота — основной способ потребления синтеза конечными пользователями.

**Independent Test**: Настроить конфиг на выбор модуля, отправить команду боту и получить голосовой ответ, подтверждая, что применился нужный модуль.

**Acceptance Scenarios**:

1. **Given** в конфиге выбран модуль синтеза, **When** бот обрабатывает текстовый запрос, **Then** он использует указанный модуль и отправляет голосовой ответ.
2. **Given** модуль недоступен, **When** бот получает запрос, **Then** он возвращает понятное сообщение об ошибке и логирует инцидент.

### Edge Cases

- Если недоступна модель или её загрузка прерывается, синтез не стартует и возвращается понятное сообщение об ошибке.
- Если текст превышает лимит (например, 1000 символов), процесс либо отклоняет запрос, либо разбивает текст по предложениям с уведомлением пользователя.
- Если путь вывода недоступен или нет прав записи, CLI завершает работу с кодом ошибки и подсказкой о корректном пути.
- При отсутствующем или некорректном конфиге используются безопасные значения по умолчанию и выводится предупреждение.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: Система должна синтезировать речь из текста с использованием модели Silero TTS с выбором идентификатора модели и спикера.
- **FR-002**: Должна существовать CLI-команда, принимающая текст напрямую и/или из файла, возвращающая путь к сгенерированному аудио и код выхода.
- **FR-003**: Вывод аудио должен сохраняться в локальный файл в формате, указанном в конфиге (дефолт: WAV/MP3), с автоматическим созданием пути назначения при возможности.
- **FR-004**: Конфигурация (model_id, speaker, язык, частота дискретизации, формат, путь вывода, устройство/режим вычислений, уровень логирования) задаётся через отдельный конфиг и переопределяется переменными окружения с префиксом `TTS_` (например, `TTS_ENGINE`, `TTS_MODEL`, `TTS_TEXT_LIMIT`, `TTS_AUDIO_FORMAT`, `TTS_SPEAKER`, `TTS_LANGUAGE`, `TTS_SAMPLE_RATE`, `TTS_DEVICE`, `TTS_CACHE_DIR`, `TTS_OUTPUT_DIR`, `TTS_MODEL_URL`, `TTS_MODEL_CONFIG_URL`, `TTS_MODEL_PATH`, `TTS_METRICS_FILE`).
- **FR-005**: Для каждого запроса должны фиксироваться метрики времени загрузки модели (однократно при старте), времени синтеза и длительности выходного аудио; метрики доступны в логах и/или через простой экспортёр (stdout/файл).
- **FR-006**: При ошибках (некорректный текст, отсутствующая модель, проблемы записи файла) CLI возвращает ненулевой код и человекочитаемое сообщение.
- **FR-007**: Должен быть минимальный механизм валидации входного текста (длина, допустимые символы) с ясным ответом при нарушениях.
- **FR-008**: Повторный синтез с одинаковыми входами и настройками должен быть детерминирован по содержимому аудио при условии неизменной версии модели.
- **FR-009**: Бот должен использовать модуль синтеза, выбранный в конфиге, для формирования голосовых ответов на текстовые запросы, с fallback на текстовое уведомление при недоступности синтеза.

### Key Entities *(include if feature involves data)*

- **Текстовая заявка**: входной текст, язык, источник (CLI аргумент или файл).
- **Параметры конфигурации**: выбранный голос/язык, формат и путь вывода, устройство вычислений, уровень логов, пределы длины текста.
- **Задача синтеза**: связка входного текста, применённой конфигурации, метрик времени и результирующего файла.
- **Метрики производительности**: время загрузки модели, время синтеза, длительность аудио, коды завершения.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 95% запусков CLI с текстом до 500 символов завершаются успешно и создают аудио менее чем за 8 секунд на целевой среде при sample_rate 48 кГц.
- **SC-002**: 100% запусков CLI выводят метрики времени синтеза и длительности аудио в журнал или отдельный канал.
- **SC-003**: Изменение параметров в конфиге (model_id, speaker, формат, частота дискретизации) отражается в результатах синтеза без модификации кода и без перезапуска установки зависимостей.
- **SC-004**: При ошибках ввода или файловой системы CLI завершается ненулевым кодом и сообщает причину, распознаваемую пользователем без просмотра исходного кода.
- **SC-005**: 95% текстовых запросов в боте получают голосовой ответ, сгенерированный модулем синтеза, указанным в конфиге; при недоступности модуля возвращается понятное текстовое сообщение.

## Assumptions

- Применяется офлайн режим: модель Silero и веса доступны локально или загружаются однократно при первом запуске; предпочитаемые env-настройки: `TTS_ENGINE=silero`, `TTS_MODEL=<model_id>`, `TTS_AUDIO_FORMAT=wav|mp3`, `TTS_SPEAKER=<speaker>`, `TTS_LANGUAGE=<lang>`, `TTS_SAMPLE_RATE=<hz>`, `TTS_DEVICE=cpu|cuda`, `TTS_TEXT_LIMIT=<chars>`, `TTS_CACHE_DIR=<path>`, `TTS_OUTPUT_DIR=<path>`, `TTS_MODEL_URL`/`TTS_MODEL_CONFIG_URL` или `TTS_MODEL_PATH` (локальные веса), `TTS_METRICS_FILE` (если нужен лог метрик).
- Поддерживаются тексты на языках, покрываемых выбранными голосами Silero; дефолт — русский/английский голос из модели.
- Формат вывода по умолчанию WAV/MP3, рекомендованная частота 48 кГц для v5_ru; иные форматы допускаются, если поддерживаются моделью или библиотекой.
- Запуск из CLI рассчитан на однопоточную локальную генерацию; масштабирование параллельности рассматривается отдельно от данной задачи.

## Clarifications

### Session 2025-12-10
- Q: Что делать, если Silero TTS недоступен (веса/torch hub/устройство/OMM)? → A: Возвращать текстовую ошибку, синтез не выполнять, код выхода CLI ненулевой.
- Q: Как отвечать в боте при недоступности Silero? → A: Отправить текст «синтез недоступен» (при debug добавить trace), голос не отправлять.


