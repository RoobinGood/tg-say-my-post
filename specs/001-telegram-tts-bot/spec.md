# Feature Specification: Telegram TTS Bot

**Feature Branch**: `001-telegram-tts-bot`  
**Created**: 2025-12-10  
**Status**: Draft  
**Input**: User description: "создай telegram бота, который будет принимать сообщения от пользователя, генерировать озвучку и отправлять аудио в ответ на сообщение. Пользовательский кейс бота - накидать очередь постов и затем прослушать их подряд в аудие"

## Clarifications

### Session 2025-12-10

- Q: Максимальная длина текста для озвучки? → A: 2000 символов.

## User Scenarios & Testing *(mandatory)*

<!--
  IMPORTANT: User stories should be PRIORITIZED as user journeys ordered by importance.
  Each user story/journey must be INDEPENDENTLY TESTABLE - meaning if you implement just ONE of them,
  you should still have a viable MVP (Minimum Viable Product) that delivers value.
  
  Assign priorities (P1, P2, P3, etc.) to each story, where P1 is the most critical.
  Think of each story as a standalone slice of functionality that can be:
  - Developed independently
  - Tested independently
  - Deployed independently
  - Demonstrated to users independently
-->

### User Story 1 - Озвучка текстового сообщения (Priority: P1)

Пользователь отправляет текстовое сообщение боту и получает голосовое сообщение с озвученным содержимым в том же чате.

**Why this priority**: Основная ценность — быстро прослушать свои черновики или наброски без ручного чтения.

**Independent Test**: Отправить текст боту и убедиться, что в ответ приходит голосовое сообщение с содержимым.

**Acceptance Scenarios**:

1. **Given** пользователь отправил текст, **When** бот его получил, **Then** бот отвечает голосовым сообщением с озвученным текстом.
2. **Given** пользователь отправил несколько текстов подряд, **When** голосовые отправляются, **Then** ответы идут в порядке отправки.
3. **Given** пользователь отправил обычный текст без пересылки, **When** бот озвучивает, **Then** голос содержит только текст без предваряющих фраз.

---

### User Story 2 - Озвучка пересланных постов (Priority: P2)

Пользователь пересылает посты из каналов или сообщения других пользователей, бот озвучивает текст и добавляет голосовое объявление источника в голосовом ответе.

**Why this priority**: Помогает быстро прослушать накопленные пересылки, сохраняя контекст их происхождения.

**Independent Test**: Переслать сообщение от пользователя и пост из канала, убедиться в правильном голосовом префиксе и содержимом в голосовом ответе.

**Acceptance Scenarios**:

1. **Given** переслано сообщение пользователя, **When** бот озвучивает, **Then** голосовое начинается с «сообщение от пользователя <имя>» и далее текст.
2. **Given** переслан пост канала, **When** бот озвучивает, **Then** голосовое начинается с «пост из канала <название>» и далее текст.

---

### User Story 3 - Прослушивание очереди постов (Priority: P3)

Пользователь отправляет серию сообщений/пересылок, чтобы потом прослушать их подряд; бот хранит порядок и выдаёт голосовые ответы по последовательности.

**Why this priority**: Основной кейс — собрать подборку постов и прослушать без пропусков и перестановок.

**Independent Test**: Отправить 5 сообщений подряд и проверить, что голосовые ответы приходят в той же последовательности без пропусков.

**Acceptance Scenarios**:

1. **Given** отправлена серия текстов, **When** бот генерирует голосовые, **Then** порядок ответов совпадает с порядком отправки.
2. **Given** во время обработки поступают новые сообщения, **When** бот отвечает, **Then** новые голосовые добавляются в конец очереди.

---

### Edge Cases

- Сообщение без текста (стикер, фото, голос) — если нет текста/подписи, бот сообщает, что озвучивать нечего; если есть вложение без текста, бот отвечает «не могу озвучить этот формат, пришлите текст».
- Пересланный пост без имени/названия (скрытый автор) — бот пропускает упоминание источника и озвучивает только текст.
- Очень длинный текст — бот сообщает об ограничении и не пытается озвучить сверх лимита.
- Пустая очередь после /start — бот даёт инструкцию, но не отправляет аудио.
- Повторное сообщение идентично предыдущему — обрабатывается как отдельный элемент очереди.
- Исходный тестовый mp3 для заглушки недоступен — бот возвращает понятную ошибку пользователю.
- В чате запрещены голосовые — бот отправляет текст с инструкцией, как включить voice для бота (Settings → Privacy and Security → Voice messages).

## Requirements *(mandatory)*

<!--
  ACTION REQUIRED: The content in this section represents placeholders.
  Fill them out with the right functional requirements.
-->

### Functional Requirements

- **FR-001**: Бот MUST отвечать на команду `/start` краткой инструкцией о том, какие сообщения принимает и что вернёт.
- **FR-002**: Бот MUST принимать только текстовые сообщения или пересланные тексты; при отсутствии текста MUST отвечать, что озвучивать нечего; если пришло вложение без текста/подписи — MUST отвечать «не могу озвучить этот формат, пришлите текст».
- **FR-003**: При пересланном сообщении пользователя голосовое MUST начинаться с фразы «сообщение от пользователя <имя>».
- **FR-004**: При пересланном посте из канала голосовое MUST начинаться с фразы «пост из канала <название>».
- **FR-005**: Для обычного текста голосовое MUST содержать только озвученный текст без дополнительных префиксов.
- **FR-006**: Бот MUST генерировать и отправлять голосовой ответ как реплай на исходное сообщение в том же чате.
- **FR-007**: Система MUST поддерживать очередь озвучек per пользователь/чат, сохраняя порядок поступления сообщений при выдаче голосовых ответов.
- **FR-008**: Система MUST иметь заглушку модуля синтеза, которая всегда возвращает предзаготовленный mp3-файл для тестовых голосовых ответов.
- **FR-009**: Система MUST логировать ошибки синтеза/отправки и информировать пользователя понятным текстом, не раскрывая технические детали.
- **FR-010**: Поддерживать управление конфигурацией через окружение (whitelist чатов/пользователей, выбор варианта озвучки/языка, уровень логирования).
- **FR-011**: Бот MUST отклонять или сокращать сообщения длиннее 2000 символов с понятным уведомлением пользователю.

### Key Entities *(include if feature involves data)*

- **IncomingItem**: Представляет текст, тип источника (прямое, переслано от пользователя, пост канала), имя/название источника, метка времени.
- **AudioJob**: Запись в очереди с ссылкой на IncomingItem, статусом (ожидает, синтезируется, отправлено), порядковым номером.
- **SynthResult**: Результат заглушки синтеза с готовым mp3 и указанием использованного префикса.

### Assumptions

- Есть рабочий токен Telegram-бота и доступ к сетевому подключению для отправки сообщений и файлов.
- Текстовые сообщения не превышают 2000 символов для озвучки и реплая.
- Тестовый mp3-файл доступен в заглушке синтеза и может быть отправлен пользователю без доп. лицензий.
- Очередь обрабатывается в рамках одного процесса бота; распределённая очередь не требуется на этом этапе.

## Success Criteria *(mandatory)*

<!--
  ACTION REQUIRED: Define measurable success criteria.
  These must be technology-agnostic and measurable.
-->

### Measurable Outcomes

- **SC-001**: 95% текстовых сообщений получают голосовой ответ в том же чате не позднее чем через 10 секунд после получения.
- **SC-002**: 100% сообщений без текста получают пояснение «озвучивать нечего» без попытки синтеза.
- **SC-003**: 95% пересылок получают корректный голосовой префикс (пользователь или канал) перед основным текстом.
- **SC-004**: При отправке 5 и более сообщений подряд все голосовые ответы доставляются в порядке очереди без пропусков или перестановок.

