# Feature Specification: Text Preprocessing Refactoring with LLM

**Feature Branch**: `006-text-preprocessing-llm`  
**Created**: 2025-12-12  
**Status**: Draft  
**Input**: User description: "Рефакторинг и доработка предпроцессинга текста"

## Clarifications

### Session 2025-12-12

- Q: Как обрабатывать длинные тексты превышающие лимит токенов LLM? → A: Разбивать на части по абзацам/предложениям, обрабатывать последовательно; минимальный размер чанка настраивается (чтобы не ходить в LLM слишком часто)
- Q: Что делать при невалидном ответе LLM? → A: Повторить запрос (настраиваемое кол-во retry), при неудаче fallback на программную очистку
- Q: Как обрабатывать нерусскую кириллицу (укр/бел)? → A: Оставлять как есть, не транслитерировать
- Q: Что делать если файл промпта не найден? → A: Возвращать ошибку при запуске системы
- Q: Какой таймаут для запросов к LLM? → A: Настраиваемый, дефолт 30 секунд
- Q: Стратегия чанкинга длинных текстов? → A: Настраиваемый минимальный размер чанка для оптимизации кол-ва запросов

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Basic Text Cleanup (Priority: P1)

Пользователь отправляет боту текст с emoji, без знаков препинания и с некорректным регистром. Система автоматически очищает текст и добавляет базовую пунктуацию для корректного синтеза речи.

**Why this priority**: Базовая очистка критична для работы TTS — без неё синтезатор может выдавать некорректный результат или ошибки.

**Independent Test**: Можно протестировать отправкой текста с emoji и без пунктуации, проверив что результат содержит только допустимые символы и корректную пунктуацию.

**Acceptance Scenarios**:

1. **Given** текст абзаца без завершающей точки, **When** текст обрабатывается, **Then** в конце абзаца появляется точка
2. **Given** текст начинающийся с маленькой буквы, **When** текст обрабатывается, **Then** первая буква абзаца становится заглавной
3. **Given** текст с emoji в начале строки, **When** текст обрабатывается, **Then** emoji заменяется на тире
4. **Given** текст с emoji внутри предложения, **When** текст обрабатывается, **Then** emoji удаляется

---

### User Story 2 - LLM Phonetic Transliteration (Priority: P1)

Пользователь отправляет текст содержащий латиницу, числа или специальные символы. Система отправляет текст в LLM для фонетической транслитерации, получая на выходе текст пригодный для русскоязычного TTS.

**Why this priority**: Без транслитерации TTS не сможет корректно озвучить английские слова, числа и аббревиатуры, что критично для качества озвучки.

**Independent Test**: Отправить текст "API версии 2.5 стоит $100" и проверить что результат содержит только кириллицу и знаки препинания.

**Acceptance Scenarios**:

1. **Given** текст "проверь API", **When** текст обрабатывается LLM, **Then** результат содержит "проверь эй пи ай" (или аналогичную транслитерацию)
2. **Given** текст "цена 1500 рублей", **When** текст обрабатывается LLM, **Then** результат содержит "цена тысяча пятьсот рублей"
3. **Given** текст "скидка 50%", **When** текст обрабатывается LLM, **Then** результат содержит "скидка пятьдесят процентов"
4. **Given** текст "1/4 стакана", **When** текст обрабатывается LLM, **Then** результат содержит "четверть стакана" или "одна четвёртая стакана"
5. **Given** текст "температура -15°C", **When** текст обрабатывается LLM, **Then** результат содержит "температура минус пятнадцать градусов цельсия"

---

### User Story 3 - Stress Mark Placement (Priority: P2)

Пользователь отправляет текст со словами допускающими разное ударение. LLM анализирует контекст и расставляет знаки ударения для корректного произношения.

**Why this priority**: Неправильное ударение снижает качество озвучки, но не блокирует работу системы.

**Independent Test**: Отправить текст "замок на двери" и "старинный замок", проверить что ударения расставлены по-разному.

**Acceptance Scenarios**:

1. **Given** текст "дверной замок", **When** текст обрабатывается LLM, **Then** результат содержит "дверной зам+ок" (ударение на второй слог)
2. **Given** текст "средневековый замок", **When** текст обрабатывается LLM, **Then** результат содержит "средневековый з+амок" (ударение на первый слог)
3. **Given** текст без омографов, **When** текст обрабатывается LLM, **Then** знаки ударения не добавляются излишне

---

### User Story 4 - LLM Configuration (Priority: P2)

Администратор настраивает параметры подключения к LLM API через переменные окружения или конфигурационный файл.

**Why this priority**: Гибкая настройка позволяет использовать разных провайдеров LLM, но система может работать с настройками по умолчанию.

**Independent Test**: Изменить URL API и ключ в конфигурации, проверить что система подключается к указанному провайдеру.

**Acceptance Scenarios**:

1. **Given** валидные параметры LLM API, **When** система запускается, **Then** подключение к API успешно
2. **Given** кастомный системный промпт в файле, **When** система запускается, **Then** используется промпт из файла
3. **Given** невалидный API ключ, **When** текст отправляется на обработку, **Then** возвращается понятная ошибка
4. **Given** текст превышающий лимит токенов, **When** текст отправляется на обработку, **Then** система разбивает текст на части или возвращает ошибку

---

### User Story 5 - Fallback Without LLM (Priority: P3)

Если LLM недоступен или не настроен, система выполняет только программную очистку текста без транслитерации.

**Why this priority**: Обеспечивает graceful degradation — бот продолжает работать даже без LLM.

**Independent Test**: Отключить LLM конфигурацию, отправить текст и проверить что базовая очистка выполняется.

**Acceptance Scenarios**:

1. **Given** LLM не настроен, **When** текст обрабатывается, **Then** выполняется только программная очистка
2. **Given** LLM временно недоступен, **When** текст обрабатывается, **Then** система логирует ошибку и возвращает программно очищенный текст

---

### Edge Cases

- Что происходит при пустом тексте после очистки?
- Нерусская кириллица (укр/бел): оставляется без изменений
- Невалидный ответ LLM: retry (настраиваемое кол-во), затем fallback на программную очистку
- Длинные тексты: разбиваются на чанки (настраиваемый мин. размер), обрабатываются последовательно
- Отсутствующий файл промпта: ошибка при запуске системы

## Requirements *(mandatory)*

### Functional Requirements

#### Программная очистка текста

- **FR-001**: Система ДОЛЖНА удалять emoji из текста (существующая функциональность)
- **FR-002**: Система ДОЛЖНА заменять emoji в начале строки на тире (существующая функциональность)
- **FR-003**: Система ДОЛЖНА добавлять точку в конце абзаца если отсутствует завершающий знак препинания
- **FR-004**: Система ДОЛЖНА делать первую букву абзаца заглавной
- **FR-005**: Система ДОЛЖНА удалять URL-ссылки из текста (они не озвучиваются)

#### LLM транслитерация

- **FR-006**: Система ДОЛЖНА отправлять текст в LLM для фонетической транслитерации
- **FR-007**: LLM ДОЛЖЕН заменять слова/аббревиатуры на латинице на фонетическую запись кириллицей
- **FR-008**: LLM ДОЛЖЕН заменять числа на словесное произношение (целые, десятичные, дроби)
- **FR-009**: LLM ДОЛЖЕН заменять специальные символы (%, $, @, и т.д.) на словесное описание
- **FR-010**: На выходе LLM ДОЛЖЕН возвращать текст содержащий только кириллицу (включая укр/бел) и знаки препинания
- **FR-011**: LLM ДОЛЖЕН расставлять знак + перед ударной гласной в словах с неоднозначным ударением

#### Конфигурация LLM

- **FR-012**: Система ДОЛЖНА поддерживать настройку URL OpenAI-совместимого API
- **FR-013**: Система ДОЛЖНА поддерживать настройку ключа доступа к API
- **FR-014**: Система ДОЛЖНА поддерживать настройку названия модели
- **FR-015**: Система ДОЛЖНА поддерживать настройку параметров модели (temperature, top_p)
- **FR-016**: Система ДОЛЖНА поддерживать указание пути к файлу с системным промптом
- **FR-016a**: Система ДОЛЖНА возвращать ошибку при запуске если указанный файл промпта не найден
- **FR-017**: Система ДОЛЖНА предоставлять системный промпт по умолчанию в модуле препроцессинга
- **FR-018**: Система ДОЛЖНА поддерживать настройку кеширования системного промпта через messages API (для совместимых провайдеров)
- **FR-018a**: Система ДОЛЖНА поддерживать настройку количества retry при невалидном ответе LLM
- **FR-018b**: Система ДОЛЖНА поддерживать настройку таймаута запроса к LLM (дефолт 30 секунд)
- **FR-019**: Система ДОЛЖНА разбивать текст превышающий лимит токенов на части по абзацам/предложениям и обрабатывать последовательно
- **FR-019a**: Система ДОЛЖНА поддерживать настройку минимального размера чанка (для оптимизации количества запросов к LLM)

#### Программная транслитерация (fallback)

- **FR-020**: Система ДОЛЖНА поддерживать программную транслитерацию чисел в слова (num2words)
- **FR-021**: Система ДОЛЖНА поддерживать программную транслитерацию аббревиатур по словарю
- **FR-022**: Система ДОЛЖНА хранить карту транслитерации в отдельном конфигурационном файле
- **FR-023**: Если LLM выключен — использовать программную транслитерацию
- **FR-024**: Если LLM вернул невалидный результат — исправлять проблемные места программно

#### Обработка ошибок

- **FR-025**: Система ДОЛЖНА логировать ошибки взаимодействия с LLM
- **FR-026**: Система ДОЛЖНА валидировать ответ LLM на соответствие требованиям (только кириллица и пунктуация)
- **FR-027**: Система ДОЛЖНА повторять запрос к LLM при невалидном ответе (настраиваемое количество retry)
- **FR-028**: После retry система ДОЛЖНА исправлять оставшиеся проблемы программно

### Key Entities

- **LLMConfig**: Конфигурация LLM — URL, ключ, модель, параметры, путь к промпту, таймаут, retry, мин. размер чанка
- **LLMClient**: Клиент для взаимодействия с OpenAI-совместимым API
- **TranslitConfig**: Словарь транслитерации из JSON файла (аббревиатуры, символы)

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: Текст содержащий латиницу после обработки содержит только кириллицу и знаки препинания
- **SC-002**: Числа в тексте заменяются на корректное словесное произношение в 95% случаев
- **SC-003**: Время обработки текста до 500 символов не превышает 10 секунд (включая вызов LLM)
- **SC-004**: При недоступности LLM система продолжает работать с программной очисткой
- **SC-005**: Омографы в контексте получают корректное ударение в 90% случаев
- **SC-006**: Ошибки LLM логируются и не приводят к падению системы

## Assumptions

- OpenAI-совместимый API доступен (OpenAI, Anthropic через прокси, локальные модели через Ollama/LM Studio и т.д.)
- Модель LLM способна выполнять инструкции по транслитерации на русском языке
- Системный промпт достаточно детален для корректной работы транслитерации
- Кеширование промпта через messages API поддерживается не всеми провайдерами (опциональная функция)
